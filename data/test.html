<html>
<head>
  <title>Orrery - Test</title>
</head>
<body>
	<link href='/style.css' rel='stylesheet' type='text/css'>
	<link href='/electrolize.css' rel='stylesheet' type='text/css'>
	<div id="app_frame">
		<div id="clock_frame">
			<div id="orrery_time"></div>
			<div id="time_to_destination"></div>
		</div>
		<div id="controls_frame">
			<div id="mode_orrery">
				<div id="planetarium"><canvas id="planets" width-"100%" height="100%"></canvas></div>
				<div id="locations"></div>
			</div>
			<div id="mode_expert">
				<div id="expert_controls"></div>
				<div id="speed_slider"></div>
				<div id="expert_buttons"></div>
			</div>
			<div id="mode_admin">
				<div id="admin_controls"></div>
				<div id="status"></div>
				<div id="settings"></div>
			</div>
		</div>
	</div>
<script src='/dofonts.js'></script>
<script src="circletext.js"></script>
<script>
	// Planets, sizes, and colors
	let pInfo = new Map([
		['Mercury', [ 2, '#909090']],
		['Venus',   [ 4, '#B07000']],
		['Earth',   [ 4, '#3050FF']],
		['Mars',    [ 3, '#B01010']],
		['Jupiter', [ 9, '#907005']],
		['Saturn',  [ 8, '#909000']],
		['Uranus',  [ 6, '#15B015']],
		['Neptune', [ 6, '#4040FF']]
	]);

	// Cache the planet images
	let images = new Map();
	for (let [name, values] of pInfo.entries()) {
		let img = new Image();
		img.src = '/data/'+name+'.png';
		images[name] = img;
	}

	// Table of month lengths for angle to date conversion
	let months = [
		['Jan', 31], ['Feb', 28], ['Mar', 31], ['Apr', 30], ['May', 31], ['Jun', 30],
		['Jul', 31], ['Aug', 31], ['Sep', 30], ['Oct', 31], ['Nov', 30], ['Dec', 31]];

	function dateFromDay(day){
	    var date = new Date();
		date.setMonth(0);
	    return new Date(date.setDate(day)); // add the number of days
	}

	function radians(a) {return a * Math.PI / 180;}

    function updatePlanetarium(data) {
		el = document.getElementById("planetarium");
		width = parseFloat(el.style.width);
		height = parseFloat(el.style.height);
        var c = document.getElementById("planets");
		c.width = width;
		c.height = height;
        var ctx = c.getContext("2d");
        let size = Math.min(width, height) / 2;
        let dist = size / 10;
        var radius = dist;

        ctx.clearRect(0, 0, width, height);

		// Draw month names, and separators
		ctx.font = '' + (size / 15) + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
		ctx.setLineDash([]);
		ctx.strokeStyle = '#777';
		let day = 0;
		let offset = 100.231 - 90;
		for (let [name, days] of months) {
			let a = radians(offset + day * 360 / 365);
			let x = Math.cos(a) * dist * 10;
            let y = Math.sin(a) * dist * 10;
			ctx.beginPath();
            ctx.moveTo(size, size);
            ctx.lineTo(size + x, size - y);
			for (d = 1; d < days; d += 1) {
				a = radians((offset + day + d) * 360 / 365);
				x = Math.cos(a) * dist * 9;
            	y = Math.sin(a) * dist * 9;
				let distance = (d % 7 ? 9.2 : 9.4);
				ctx.moveTo(size + x, size - y);
				x = Math.cos(a) * dist * distance;
            	y = Math.sin(a) * dist * distance;
				ctx.lineTo(size + x, size - y);
			}
            ctx.stroke();

			a = offset + (day + days / 2) * (360 / 365);
			txt = getCircularText(name, dist*10*2, -a, 'center', true, true, ctx.font, size/15, 0 );
			ctx.drawImage(txt, (width-txt.width)/2, (height-txt.height)/2);
			day += days;
		}
		ctx.stroke();

		positions = data.positions;
    	ctx.setLineDash([2,4]);
        for (let [name, values] of pInfo.entries()) {
            // Draw the orbit
            ctx.beginPath();
            ctx.arc(size, size, radius, 0, 2*Math.PI);
            ctx.strokeStyle = values[1];
            ctx.stroke();

            // Draw the planet
            let angle = positions[name][0];
            let x = Math.cos(radians(angle)) * radius;
            let y = Math.sin(radians(angle)) * radius;

			let rrx=values[0]*5;
			let rr=rrx/2;
			ctx.drawImage(images[name], size+x-rr, size-y-rr, width=rrx, height=rrx);

			radius += dist;
        }
    }

    function updateLocations(data) {
        c = document.getElementById("locations");
        fontSize = parseFloat(c.style.height) / 12;

		t = document.createElement('table');
        t.style.fontFamily  = 'Electrolize';
		t.style.fontSize = fontSize;
		t.style.width = c.style.width;
		t.align = 'center';
		positions = data.positions;
        for (let [name, values] of pInfo.entries()) {
            tr = t.insertRow();
			tc = tr.insertCell();
			tc.innerHTML = '<img src="/data/'+name+'.png" height="'+fontSize+'">';
			tc.className = 'image';
            tc = tr.insertCell();
            tc.textContent = name;
            tc.style.color = values[1];
			tc.className = 'name';
            tc = tr.insertCell();
            tc.textContent = Math.round(positions[name][0], 0);
            tc.style.color = values[1];
            tc.className = 'angle';
            tc = tr.insertCell()
			doy = 365 * ((positions[name][0] - 90) / 360) - 10;
			d = dateFromDay(doy);
            tc.textContent = d.toString().substring(4,10);
            tc.style.color = values[1];
			tc.className = 'doy';
        }

        c.replaceChildren(t);
    }
</script>
<script>
	moveTable = ['Steps', 'Days', 'Mercury', 'Venus', 'Earth', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];

	amounts = [
			[-100, 	'large'],
			[-10, 	'medium'],
			[-1, 	'small'],
			[0,		'none'],
			[1,		'small'],
			[10,	'medium'],
			[100,	'large']
			];

	function makeExpertControls() {
		t = document.createElement('table');
		t.style.fontFamily = 'Electrolize';
		t.align = 'center';
		for (name of moveTable) {
			tr = t.insertRow();
			for ([amt, className] of amounts) { 
				tc = tr.insertCell();
				if (amt == 0) {
					tc.textContent = name;
					tc.align = 'center';
					tc.className = "range";
				}
				else {
					butt = document.createElement('button');
					//butt.value = amt;
					butt.className = className;
					butt.innerHTML = amt;
					butt.onclick = new Function( "move("+amt+",'"+name+"')");
					tc.replaceChildren(butt);
				}
			}
		}
		document.getElementById('expert_controls').replaceChildren(t);
	}
</script>
<script>
	modes = [
		{ 'mode': 'orrery', 'id': 'mode_orrery' },
		{ 'mode': 'expert', 'id': 'mode_expert' },
		{ 'mode': 'admin',  'id': 'mode_admin' }
	];

	function setMode(mode) {
		for (m of modes) {
			let el = document.getElementById(m['id']);
			let disp = ((mode == m['mode']) ? 'block' : 'none');
			el.style.display = disp;
		}
	}

	function resize() {
		function setSize(id, w, h, fs="100%") {
			let el = document.getElementById(id);
			el.style.width = w;
			el.style.height = h;
			el.style.fontSize = fs;
		}

		// Force an aspect ration of 16:9 (1.78, the standard)
		let h=document.body.clientHeight;
		let w=document.body.clientWidth;
		let fh = Math.min(w * 1.78, h);
		let fw = Math.min(w, h / 1.78);

		let clock_height = fh * .15;
		let controls_height = fh * .85;
		setSize("app_frame", fw, fh);
		setSize("clock_frame", fw, clock_height);
		setSize("orrery_time", fw, clock_height * .75, clock_height * .75 * .45);
		setSize("time_to_destination", fw, clock_height * .25, clock_height * .25 * .6);
		setSize("controls_frame", fw, controls_height);

		// Orrery mode layout
		setSize("planetarium", fw, fw);
		setSize("locations", fw, controls_height - fw);

		// Expert mode layout
		setSize("expert_controls", fw, controls_height * 10 / 12);
		setSize("speed_slider", fw, controls_height / 12);
		setSize("expert_buttons", fw, controls_height / 12);

		// Admin mode layout
		setSize("admin_controls", fw, controls_height / 25);
		setSize("status", fw, controls_height * 7 / 25);
		setSize("settings", fw, controls_height * 18 / 25);
	}

	function updateClock(data) {
    	let el = document.getElementById("orrery_time");
		if (data.state.state == 'moving')		el.style.color = "#FFFF00";
		else if (data.state.mode == 'now')		el.style.color = "#00FF00";
		else if (data.state.mode == 'travel')	el.style.color = "#AF00FF";
		else									el.style.color = "#FF0000";
        el.textContent = data.time;

		seconds = Math.abs(data.status.cur_pos[0] - data.status.target_pos[0]) / data.status.max_speed[0];
		minutes = Math.floor(seconds / 60);
		seconds = Math.floor(seconds % 60);
		document.getElementById("time_to_destination").innerHTML = minutes + ' minutes, ' + seconds + ' seconds to destination';
	}

	updateSubscribers = {};
	function subscribe(f) {
		updateSubscribers[f] = f;
	}

	function main() {
		resize();
		document.body.onresize = resize;
					
		makeExpertControls();
		setMode('orrery');
		subscribe(updateClock);
		subscribe(updatePlanetarium);
		subscribe(updateLocations);

		function statusUpdate(event) {
			data = JSON.parse(event.data);
			for (f in updateSubscribers)
				updateSubscribers[f](data);
		};
	    	
		uri = 'ws://' + window.location.host + '/websocket/status';
		let sock = new WebSocket(uri)
		sock.addEventListener('message', statusUpdate)
    }
    main();
</script>
</body>
</html>
