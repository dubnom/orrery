<html>
<head>
  <title>Orrery - Admin</title>
</head>
<body style="background-color:#111;">
	<link href='/style.css' rel='stylesheet' type='text/css'>
	<link href='/electrolize.css' rel='stylesheet' type='text/css'>
	<div id="icon1"><a href="/orrery.html"><img src="/data/icon-orbit.png"></a></div>
	<div id="icon2"><a href="/expert.html"><img src="/data/icon-expert.png"></a></div>
	<div id="icon3"><a href="/admin.html"><img src="/data/icon-admin.png" class="icon_selected"></a></div>
	<div id="clock">
	</div>
	<div id="analytics">
	</div>
	<div id="live_controls">
		<table>
			<tr>
				<td colspan=7 align='center'>
					<input type="button" value="HALT!" onclick="halt()"/>
					<input type="button" value="De-energize" onclick="deenergize()"/>
					<input type="button" value="Resume" onclick="resume()"/>
					<input type="button" value="Now" onclick="now()"/>
					<input type="button" value="Reset Now" onclick="resetnow()"/>
				</td>
			</tr>
		</table>
	</div>
	<div id="status" class="status">
	</div>
	<div id="settings" class="divs">
		<table id="set_table">
			<tr>
				<th colspan=2>Orrery Settings</th>
			</tr>
			<tr>
				<td>Speed</td>
				<td><input id="max_speed" type="text"/> (days per second)</td>
			</tr>
			<tr>
				<td>Current</td>
				<td><input id="current" type="text"/> (amps)</td>
			</tr>
			<tr>
				<td>Time zone</td>
				<td><select id="timezone" name="timezone"></select></td>
			</tr>
			<tr>
				<th colspan=2><hr><br>WiFi Settings</th>
			</tr>
			<tr>
				<td>Startup Mode</td>
				<td>
					<input id="wifi_server" type="radio" name="wifi_mode" value="server"><label for="wifi_server">Access Point</label>
					<input id="wifi_client" type="radio" name="wifi_mode" value="client" checked><label for="wifi_client">Client</label>
				</td>
			</tr>
			<tr>
				<td>Country code</td>
				<td><select id="wifi_country" name="wifi_country"></select></td>
			</tr>
			<tr><td colspan=2></td></tr>
			<tr>
				<td colspan=2><i><u>Access Point Settings</u></i></td>
			</tr>
			<tr>
				<td>SSID</td>
				<td><input id="ap_ssid" type="text" size="50"/></td>
			</tr>
			<tr>
				<td>Password</td>
				<td><input id="ap_pass" type="password" size="50" autocomplete="current-password"/></td>
			</tr>
			<tr>
				<td>Channel</td>
				<td><input id="ap_channel" type="number" min="0" max="12"/></td>
			</tr>
			<tr><td colspan=2></td></tr>
			<tr>
				<td colspan=2><i><u>Client Settings</u></i></td>
			</tr>
			<tr>
				<td>SSID</td>
				<td><input id="client_ssid" type="text" size="50"/></td>
			</tr>
			<tr>
				<td>Password</td>
				<td><input id="client_pass" type="password" size="50" autocomplete="current-password"/></td>
			</tr>
			<tr>
				<td colspan=2 align='center'><input id="apply_settings" class="apply" type="button" value="Apply Settings" onclick="setSettings()"/></td>
			</tr>
			<tr><td colspan=2></td></tr>
			<tr>
				<td colspan=2 align='center'><input id="reboot" class="reboot" type="button" value="Reboot" onclick="reboot()"/></td>
			</tr>
		</table>
	</div>

	<script>
		var dispFont = new FontFace('D14MR', 'url("/fonts/DSEG14-Classic/DSEG14Classic-Regular.woff")');
		dispFont.load().then(function(loadedFace) {
			document.fonts.add(loadedFace);
			document.body.style.fontFamily = '"D14MR", Electrolize';
		}).catch(function(error) {
		});
	</script>
	<script>
		function radioGetValue(name) {
			for (ele of document.getElementsByName(name))
				if (ele.checked)
					return (ele.value);
			return ('');
		}
		
		function radioSetValue(name, value) {
			for (ele of document.getElementsByName(name))
				ele.checked = (ele.value == value);
		}

		function sleep(ms) {
		    return new Promise(resolve => setTimeout(resolve, ms));
		}
	</script>							
	<script>
		// Communications with the orrery
        async function postData(url='', data={}) {
		    const response = await fetch(url, {
					method:'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(data)});
			return await response.json();
		}

		function halt() {
			postData('/api/halt');
		}

		function deenergize() {
			postData('/api/deenergize');
		}

		function resume() {
			postData('/api/resume');
		}

		function now() {
			postData('/api/timeNow');
		}

		function resetnow() {
			postData('/api/resetnow');
		}

		function reboot() {
			if (confirm("Are you sure you want to reboot?"))
				postData('/api/reboot');
		}

		function updateClock(time, color) {
            var c = document.getElementById("clock");
            c.style.color = color;
            c.textContent = time;
		}

		fields = [
				['Operational State', 'op_state'],
				['Error Status', 'error_status'],
				['Speed', 'max_speed'],
				['Voltage', 'vin'],
				['Current', 'current'],
				['Current Position', 'cur_pos'],
				['Target Position', 'target_pos']
				];

		function updateTable(data) {
            c = document.getElementById("status");
            fontSize = c.style.fontSize;

			t = document.createElement('table');
			t.style.fontFamily = 'Electrolize';
			t.style.width = '70%';
			t.margin = 10;
			t.align = 'center';
			for ([name, key] of fields) {
				tr = t.insertRow();
				tc = tr.insertCell();
				tc.textContent = name;
				tc = tr.insertCell();
				value = data[key][0];
				units = data[key][1];
				if (value >= 1000)
					value = value.toLocaleString();
				tc.textContent = value;
				tc.style.textAlign = 'right';
				tc = tr.insertCell();
				if (units.length)
					tc.textContent = '(' + units + ')';
			}
			document.getElementById('status').replaceChildren(t);
		}

		function updateAnalytics(data) {
			seconds = Math.abs(data.cur_pos[0] - data.target_pos[0]) / data.max_speed[0];
			minutes = Math.floor(seconds / 60);
			seconds = Math.floor(seconds % 60);
			document.getElementById('analytics').innerHTML = minutes + ' minutes, ' + seconds + ' seconds to destination';
		}

		function getSettings() {
			postData('/api/getsettings').then(settings => {
					document.getElementById('max_speed').value = Math.round(88 * ((settings['maxSpeed'] / 10000) / 3200));
					document.getElementById('current').value = settings['current'];
					radioSetValue('wifi_mode', settings['wifi_mode']);
					document.getElementById('wifi_country').value = settings['wifi_country'];
					document.getElementById('timezone').value = settings['timezone'];
					document.getElementById('ap_ssid').value = settings['ap_ssid'];
					document.getElementById('ap_pass').value = settings['ap_pass'];
					document.getElementById('ap_channel').value = settings['ap_channel'];
					document.getElementById('client_ssid').value = settings['client_ssid'];
					document.getElementById('client_pass').value = settings['client_pass'];
			});
		}

		function setSettings() {
				postData('/api/setsettings', {"settings": {
						"maxSpeed": Math.floor((parseFloat(document.getElementById('max_speed').value)/88)*3200*10000),
						"current": parseFloat(document.getElementById('current').value),
						"timezone": document.getElementById('timezone').value,
						"wifi_mode": radioGetValue('wifi_mode'),
						"wifi_country": document.getElementById('wifi_country').value,
						"ap_ssid": document.getElementById('ap_ssid').value,
						"ap_pass": document.getElementById('ap_pass').value,
						"ap_channel": document.getElementById('ap_channel').value,
						"client_ssid": document.getElementById('client_ssid').value,
						"client_pass": document.getElementById('client_pass').value
				}});
		}

		function getCountries() {
				postData('/countries').then(countries => {
						var select = document.getElementById("wifi_country");
						for (let country of countries) {
							var option = document.createElement('option');
							option.value = country[0];
							option.text  = country[1] + ' (' + country[0] + ')';
							select.appendChild(option);}
				})
		}

		function getTimeZones() {
				postData('/timezones').then(timezones => {
						var select = document.getElementById("timezone");
						for (let timezone of timezones) {
							var option = document.createElement('option');
							option.value = timezone;
							option.text = timezone;
							select.appendChild(option); }
				})
		}

		function resize() {
			var w=document.body.clientWidth
			var h=document.body.clientHeight
			var wh = Math.min(w, h / 1.8);
			let fontPct = wh / 10;
	
			let analytics = document.getElementById('analytics');
			analytics.style.width = wh;
			analytics.style.fontFamily = 'Electrolize';
			analytics.style.textAlign = 'center';

			settings = document.getElementById('settings');
			settings.style.width = wh;
			settings.style.fontFamily = 'Electrolize';
			t = document.getElementById('set_table');
			t.style.fontFamily = 'Electrolize';
			t.style.width = wh;
			t.align = 'center';

			let lcontrols = document.getElementById('live_controls');
			lcontrols.style.width = wh;
			lcontrols.style.fontFamily = 'Electrolize';
			lcontrols.align = 'center';

			let status = document.getElementById('status');
			status.style.width = wh;
			status.style.fontFamily = 'Electrolize';
			status.align = 'center';

			let clockControl = document.getElementById('clock');
			clockControl.style.width = wh;
			clockControl.style.fontFamily = 'D14MR';
			clockControl.style.fontSize = fontPct;
			clockControl.style.textAlign = 'center';
		}
		function main() {
			getCountries();
			getTimeZones();

			resize();

			getSettings();

			function statusUpdate(event) {
            	data = JSON.parse(event.data);
				updateTable(data.status);
				updateAnalytics(data.status);
				if (data.state.state == 'moving')
					color = "#FFFF00";
				else if (data.state.mode == 'now')
					color = "#00FF00";
				else if (data.state.mode == 'travel')
					color = "#AF00FF";
				else
					color = "#FF0000";
					updateClock(data.time, color);
	    	}

			uri = 'ws://' + window.location.host + '/websocket/status';
			let sock = new WebSocket(uri)
			sock.addEventListener('message', statusUpdate)
        }
        main();
	</script>
</body>
