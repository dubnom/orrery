<html>
<head>
</head>
<style>
	html, body {
    	height: 100%;
	}

	html {
   		display: table;
    	margin: auto;
	}

	body {
    	display: table-cell;
    	vertical-align: middle;
		color: #FFF;
	}

	.divs {
  		border: 2px outset yellow;
    	background-color: #222;
	  	text-align: center;
	}

	.status {
  		border: 2px outset lightgreen;
    	background-color: #181818;
	}

	input.large {
		color: #FFF;
		background-color: #C55;
	}

	input.medium {
		color: #FFF;
		background-color: #AA0;
	}

	input.small {
		color: #FFF;
		background-color: #0A0;
	}

	#icon img {
		position: absolute;
		top: 8px;
		right: 8px;
		width: 32px;
		height: 32px;
	}
</style>
<body style="background-color:#111;">
	<link href='electrolize.css' rel='stylesheet' type='text/css'>
	<div id="icon"><a href="/"><img src="/data/icon-orbit.png"></a></div>
	<div id="clock">
	</div>
	<div id="analytics">
	</div>
	<div id="live_controls">
		<table>
			<tr>
				<td colspan=7 align='center'>
					<input type="button" value="HALT!" onclick="halt()"/>
					<input type="button" value="De-energize" onclick="deenergize()"/>
					<input type="button" value="Resume" onclick="resume()"/>
					<input type="button" value="Now" onclick="now()"/>
					<input type="button" value="Reset Now" onclick="resetnow()"/>
				</td>
			</tr>
		</table>
	</div>
	<div id="status" class="status">
	</div>
	<div id="settings" class="divs">
		<table id="set_table">
			<tr>
				<th colspan=2>Orrery Settings</th>
			</tr>
			<tr>
				<td>Speed</td>
				<td><input id="max_speed" type="text"/> (days per second)</td>
			</tr>
			<tr>
				<td>Current</td>
				<td><input id="current" type="text"/> (amps)</td>
			</tr>
			<tr>
				<th colspan=2>WiFi</th>
			</tr>
			<tr>
				<td>Mode</td>
				<td><input id="wifi_client" type="radio" value="client" checked><label for="wifi_client">Connect as a Client</label>
					<input id="wifi_server" type="radio" value="server"><label for="wifi_server">Run as Access Point</label>
				</td>
			</tr>
			<tr>
				<td>Name</td>
				<td><input id="wifi_name" type="text" size="50"/></td>
			</tr>
			<tr>
				<td>Password</td>
				<td><input id="wifi_password" type="password" size="50" autocomplete="current-password"/></td>
			</tr>
			<tr>
				<td colspan=2 align='center'><input id="apply_settings" type="button" value="Apply Settings" onclick="setSettings()"/></td>
			</tr>
		</table>
	</div>

	<script>
		var dispFont = new FontFace('D14MR', 'url("/fonts/DSEG14-Classic/DSEG14Classic-Regular.woff")');
		dispFont.load().then(function(loadedFace) {
			document.fonts.add(loadedFace);
			document.body.style.fontFamily = '"D14MR", Electrolize';
		}).catch(function(error) {
		});
	</script>
	<script>
		// Communications with the orrery
        async function postData(url='', data={}) {
		    const response = await fetch(url, {
					method:'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(data)});
			return await response.json();
		}

		function halt() {
			postData('/orrery/api/halt');
		}

		function deenergize() {
			postData('/orrery/api/deenergize');
		}

		function resume() {
			postData('/orrery/api/resume');
		}

		function now() {
			postData('/orrery/api/timeNow');
		}

		function resetnow() {
			postData('/orrery/api/resetnow');
		}

		function updateClock(time, color) {
            var c = document.getElementById("clock");
            c.style.color = color;
            c.textContent = time;
		}

		fields = [
				['Operational State', 'op_state'],
				['Error Status', 'error_status'],
				['Speed', 'max_speed'],
				['Voltage', 'vin'],
				['Current', 'current'],
				['Current Position', 'cur_pos'],
				['Target Position', 'target_pos']
				];

		function updateTable(data) {
            c = document.getElementById("status");
            fontSize = c.style.fontSize;

			t = document.createElement('table');
			t.style.fontFamily = 'Electrolize';
			t.style.width = '70%';
			t.margin = 10;
			t.align = 'center';
			for ([name, key] of fields) {
				tr = t.insertRow();
				tc = tr.insertCell();
				tc.textContent = name;
				tc = tr.insertCell();
				value = data[key][0];
				units = data[key][1];
				if (value >= 1000)
					value = value.toLocaleString();
				tc.textContent = value;
				tc.style.textAlign = 'right';
				tc = tr.insertCell();
				if (units.length)
					tc.textContent = '(' + units + ')';
			}
			document.getElementById('status').replaceChildren(t);
		}

		function updateAnalytics(data) {
			seconds = Math.abs(data.cur_pos[0] - data.target_pos[0]) / data.max_speed[0];
			minutes = Math.floor(seconds / 60);
			seconds = Math.floor(seconds % 60);
			document.getElementById('analytics').innerHTML = minutes + ' minutes, ' + seconds + ' seconds to destination';
		}

		function getSettings() {
			postData('/orrery/api/getsettings').then(settings => {
					document.getElementById('max_speed').value = Math.round(88 * ((settings['maxSpeed'] / 10000) / 3200));
					document.getElementById('current').value = settings['current'];
			});
		}

		function setSettings() {
				postData('/orrery/api/setsettings', {"settings": {
						"maxSpeed": Math.floor(parseFloat(document.getElementById('max_speed').value)*10000),
						"current": parseFloat(document.getElementById('current').value)
				}});
		}

		function resize() {
			var w=document.body.clientWidth
			var h=document.body.clientHeight
			var wh = Math.min(w, h / 1.8);
			let fontPct = wh / 10;
	
			let analytics = document.getElementById('analytics');
			analytics.style.width = wh;
			analytics.style.fontFamily = 'Electrolize';
			analytics.style.textAlign = 'center';

			settings = document.getElementById('settings');
			settings.style.width = wh;
			settings.style.fontFamily = 'Electrolize';
			t = document.getElementById('set_table');
			t.style.fontFamily = 'Electrolize';
			t.style.width = wh;
			t.align = 'center';

			let lcontrols = document.getElementById('live_controls');
			lcontrols.style.width = wh;
			lcontrols.style.fontFamily = 'Electrolize';
			lcontrols.align = 'center';

			let status = document.getElementById('status');
			status.style.width = wh;
			status.style.fontFamily = 'Electrolize';
			status.align = 'center';

			let clockControl = document.getElementById('clock');
			clockControl.style.width = wh;
			clockControl.style.fontFamily = 'D14MR';
			clockControl.style.fontSize = fontPct;
			clockControl.style.textAlign = 'center';
		}
		function main() {
			resize();
			document.body.onresize = resize;
	    	
			getSettings();

			function mainLoop() {
            	postData('/orrery/api/status').then(data => {
					updateTable(data.status);
					updateAnalytics(data.status);
					if (data.state.state == 'moving')
						color = "#FFFF00";
					else if (data.state.mode == 'now')
						color = "#00FF00";
					else if (data.state.mode == 'travel')
						color = "#AF00FF";
					else
						color = "#FF0000";
					updateClock(data.time, color);
				}).catch(function (error) {
					updateClock('ERROR', "#FF0000");
				});
				return 1000;
	    	}

			function looper(delay) {
				setTimeout( function() {
					let d=mainLoop();
					looper(d) }, delay);
			}
				
			looper(1000);
        }
        main();
	</script>
</body>
