<html>
  <title>Orrery - Expert</title>
<head>
</head>
<style>
	.slider {
		width: 80%;
	}
</style>
<body style="background-color:#111;">
	<link href='/style.css' rel='stylesheet' type='text/css'>
	<link href='/electrolize.css' rel='stylesheet' type='text/css'>
	<div id="icon1"><a href="/orrery.html"><img src="/data/icon-orbit.png"></a></div>
	<div id="icon2"><a href="/expert.html"><img src="/data/icon-expert.png" class="icon_selected"></a></div>
	<div id="icon3"><a href="/admin.html"><img src="/data/icon-admin.png"></a></div>
	<div id="clock">
	</div>
	<div id="analytics">
	</div>
	<div id="controls">
	</div>
	<div id="speed_div" class="speed_div">
		<div id="speed_title">Speed (days per second)</div>
		<input type="range" min="1" max="180" class="slider" id="speed" oninput="speedChange()">
	</div>
	<div id="live_controls">
		<table>
			<tr>
				<td colspan=7 align='center'>
					<input type="button" value="HALT!" onclick="halt()"/>
					<input type="button" value="De-energize" onclick="deenergize()"/>
					<input type="button" value="Resume" onclick="resume()"/>
					<input type="button" value="Now" onclick="now()"/>
				</td>
			</tr>
		</table>
	</div>

	<script>
		var dispFont = new FontFace('D14MR', 'url("/fonts/DSEG14-Classic/DSEG14Classic-Regular.woff")');
		dispFont.load().then(function(loadedFace) {
			document.fonts.add(loadedFace);
			document.body.style.fontFamily = '"D14MR", Electrolize';
		}).catch(function(error) {
		});
	</script>
	<script>
		// Communications with the orrery
        async function postData(url='', data={}) {
		    const response = await fetch(url, {
					method:'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(data)});
			return await response.json();
		}

		function move(amt, typ) {
			postData('/api/move', {'amt': amt, 'typ': typ});
		}

		function halt() {
			postData('/api/halt');
		}

		function deenergize() {
			postData('/api/deenergize');
		}

		function resume() {
			postData('/api/resume');
		}

		function now() {
			postData('/api/timeNow');
		}

		function resetnow() {
			postData('/api/resetnow');
		}

		function speedChange() {
			var c = document.getElementById("speed");
			var t = document.getElementById("speed_title");
			var speed = parseInt(c.value);
			t.innerHTML = 'Speed ' + speed + ' (days per second)';
			var stepsPerSecond = Math.floor(speed * 3200 * 10000 / 88);
			postData('/api/setsettings', {"settings": {"maxSpeed": stepsPerSecond}});
		}

		function updateClock(time, color) {
            var c = document.getElementById("clock");
            c.style.color = color;
            c.textContent = time;
		}

		function updateAnalytics(data) {
			seconds = Math.abs(data.cur_pos[0] - data.target_pos[0]) / data.max_speed[0];
			minutes = Math.floor(seconds / 60);
			seconds = Math.floor(seconds % 60);
			document.getElementById('analytics').innerHTML = minutes + ' minutes, ' + seconds + ' seconds to destination';
		}

		moveTable = ['Steps', 'Days', 'Mercury', 'Venus', 'Earth', 'Mars', 'Jupiter', 'Saturn', 'Uranus', 'Neptune'];

		amounts = [
				[-100, 	'large'],
				[-10, 	'medium'],
				[-1, 	'small'],
				[0,		'none'],
				[1,		'small'],
				[10,	'medium'],
				[100,	'large']
				];

		function makeControls() {
			t = document.createElement('table');
			t.style.fontFamily = 'Electrolize';
			t.align = 'center';
			for (name of moveTable) {
				tr = t.insertRow();
				for ([amt, className] of amounts) { 
					tc = tr.insertCell();
					if (amt == 0) {
						tc.textContent = name;
						tc.align = 'center';
						tc.className = "range";
					}
					else {
						butt = document.createElement('button');
						//butt.value = amt;
						butt.className = className;
						butt.innerHTML = amt;
						butt.onclick = new Function( "move("+amt+",'"+name+"')");
						tc.replaceChildren(butt);
					}
				}
			}
			document.getElementById('controls').replaceChildren(t);
		}

		function resize() {
			var w=document.body.clientWidth
			var h=document.body.clientHeight
			var wh = Math.min(w, h / 1.8);
			let fontPct = wh / 10;
	
			let analytics = document.getElementById('analytics');
			analytics.style.width = wh;
			analytics.style.fontFamily = 'Electrolize';
			analytics.style.textAlign = 'center';

			let controls = document.getElementById('controls');
			controls.style.width = wh;
			controls.style.fontFamily = 'Electrolize';
			controls.align = 'center';

			let speed = document.getElementById('speed_div');
			speed.style.width = wh;
			speed.style.fontFamily = 'Electrolize';
			speed.align = 'center';

			let lcontrols = document.getElementById('live_controls');
			lcontrols.style.width = wh;
			lcontrols.style.fontFamily = 'Electrolize';
			lcontrols.align = 'center';

			let clockControl = document.getElementById('clock');
			clockControl.style.width = wh;
			clockControl.style.fontFamily = 'D14MR';
			clockControl.style.fontSize = fontPct;
			clockControl.style.textAlign = 'center';
		}

		function main() {
			makeControls();
				
			resize();
			document.body.onresize = resize;

			function statusUpdate(event) {
				data = JSON.parse(event.data);
				updateAnalytics(data.status);

				if (data.state.state == 'moving')
					color = "#FFFF00";
				else if (data.state.mode == 'now')
					color = "#00FF00";
				else if (data.state.mode == 'travel')
					color = "#AF00FF";
				else
					color = "#FF0000";
				updateClock(data.time, color);
			};
	    	
			uri = 'ws://' + window.location.host + '/websocket/status';
			let sock = new WebSocket(uri)
			sock.addEventListener('message', statusUpdate)
        }
        main();
	</script>
</body>
